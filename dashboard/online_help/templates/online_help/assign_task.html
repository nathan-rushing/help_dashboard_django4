{% extends "online_help/base.html" %}
{% load static %}
{% load widget_tweaks %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/doc_sec_sub_list.css' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h3 class="mb-0">Assign Writer to Task</h3>
        </div>
        <div class="card-body">
            {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <form method="post" id="assignForm">
                {% csrf_token %}
                
                <div class="form-group">
                    {{ form.document.label_tag }}
                    {{ form.document|add_class:"form-control form-control-lg" }}
                </div>

                <div class="form-group">
                    {{ form.section.label_tag }}
                    {{ form.section|add_class:"form-control form-control-lg" }}
                </div>

                <div class="form-group">
                    {{ form.sub_section.label_tag }}
                    {{ form.sub_section|add_class:"form-control form-control-lg" }}
                </div>

                <div class="form-group">
                    {{ form.writers.label_tag }}
                    {{ form.writers }}
                </div>

                <div class="form-group">
                    {{ form.sme.label_tag }}
                    {{ form.sme|add_class:"form-control form-control-lg" }}
                </div>

                <button type="submit" class="btn btn-dark btn-lg">Submit</button>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
    $("#id_document").change(function () {
        const document_id = $(this).val();
        $.ajax({
            url: "{% url 'online_help:ajax_load_sections' %}",
            data: { 'document': document_id },
            dataType: 'json',
            success: function (data) {
                let sectionSelect = $("#id_section");
                sectionSelect.html('<option value="">Select section</option>');
                data.forEach(function (section) {
                    sectionSelect.append(
                        $("<option>").val(section.id).text(section.name)
                    );
                });
                $("#id_sub_section").html('<option value="">Select subsection</option>');
            },
            error: function() {
                alert("Error loading sections. Please try again.");
            }
        });
    });

    $("#id_section").change(function () {
        const section_id = $(this).val();
        $.ajax({
            url: "{% url 'online_help:ajax_load_subsections' %}",
            data: { 'section': section_id },
            dataType: 'json',
            success: function (data) {
                let subSelect = $("#id_sub_section");
                subSelect.html('<option value="">Select subsection</option>');
                data.forEach(function (sub) {
                    subSelect.append(
                        $("<option>").val(sub.id).text(sub.name)
                    );
                });
            },
            error: function() {
                alert("Error loading subsections. Please try again.");
            }
        });
    });
});
</script>

{% endblock %}
