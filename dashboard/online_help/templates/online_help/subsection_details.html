{% extends "online_help/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/doc_sec_sub_list.css' %}">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

<!-- Breadcrumbs -->
<p>
    <a href="{% url 'online_help:tasks_test' %}" class="hover-link"> All Tasks </a>
    ›
    <a href="{% url 'online_help:document_list' %}" class="hover-link">Radiant Documentation</a>
    ›
    <a href="{% url 'online_help:document_sections' subsection.section.document.id %}" class="hover-link">{{ subsection.section.document.name }}</a>
    ›
    <a href="{% url 'online_help:section_subsections' subsection.section.id %}" class="hover-link">{{ subsection.section.name }}</a>
    ›
    <a href="{% url 'online_help:subsection_details' subsection.id %}" class="hover-link">{{ subsection.name }}</a>
    ›
</p>

<p><a href="{% url 'online_help:section_subsections' subsection.section.id %}">← Back to {{ subsection.section.name }} Subsections</a></p>

<div class="container mt-5">
    <!-- Writers Card -->
    <div class="card shadow-sm">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
        {{ subsection.section.document.name }} — {{ subsection.section.name }} — {{ subsection.name }}
        </h4>
        <button class="btn btn-outline-dark btn-sm" onclick="showAddForm()">Add Writer</button>
    </div>

    <div class="card-body">
        <div class="mb-3">
        <h5 class="text-muted">Writers</h5>

        {% if writers %}
            {% for w in writers %}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <p class="mb-0"><strong>{{ w.name }}</strong></p>
                <a href="?remove_writer={{ w.id }}" class="btn btn-sm btn-danger"
                onclick="return confirm('Remove {{ w.name }} from this subsection?')">
                Remove
                </a>
            </div>
            {% endfor %}
        {% else %}
            <p>No writers found for this subsection.</p>
        {% endif %}
        </div>
    </div>
    </div>

    <br>

    <!-- SME Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Subject Matter Expert (SME)</h5>
            <!-- <button class="btn btn-sm btn-light text-dark" onclick="toggleSMEEdit()">Edit</button> -->
        </div>
        <div class="card-body">
            <div class="mb-3">
                <h5 class="text-muted">SMEs</h5>
                {% if sme_list %}
                    <ul class="list-group">
                        {% for sme in sme_list %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <!-- Display Mode -->
                                <span id="sme-name-{{ sme.id }}">{{ sme.name }}</span>

                                <!-- Hidden Edit Form -->
                                <form id="sme-form-{{ sme.id }}" method="post" action="{% url 'online_help:edit_sme' sme.id %}" style="display:none;" class="d-flex w-100">
                                {% csrf_token %}
                                <input type="text" name="name" value="{{ sme.name }}" class="form-control form-control-sm mr-2" />
                                <button type="submit" class="btn btn-sm btn-success">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary ml-1" onclick="cancelSMEEdit({{ sme.id }})">Cancel</button>
                                </form>

                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p id="no-sme-msg">No SMEs found for this subsection.</p>

                    <!-- Add SME Form (hidden initially) -->
                    <form id="add-sme-form" method="post" action="{% url 'online_help:add_sme' subsection.id %}" style="display:none;" class="d-flex">
                    {% csrf_token %}
                    <input type="text" name="name" placeholder="Enter SME name" class="form-control form-control-sm mr-2" />
                    <button type="submit" class="btn btn-sm btn-success">Save</button>
                    <button type="button" class="btn btn-sm btn-secondary ml-1" onclick="cancelNewSME()">Cancel</button>
                    </form>

                {% endif %}
            </div>
        </div>
    </div>


    <!-- Hidden Add Writer Form -->
    <div id="add-doc-form" class="add-form mt-3" style="display: none;">
    <h3>Add Writer</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="writer_form" value="1">
        <div class="form-group">
        {{ form.writer.label_tag }}
        {{ form.writer }}
        </div>
        <button type="submit" class="btn btn-outline-dark btn-sm">Submit</button>
    </form>
    </div>

</div>

<script>
function showAddForm() {
    const form = document.getElementById('add-doc-form');
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
}

function editSME() {
    document.getElementById('sme-display').style.display = 'none';
    document.getElementById('edit-sme-form').style.display = 'flex';
}

function cancelEdit() {
    document.getElementById('edit-sme-form').style.display = 'none';
    document.getElementById('sme-display').style.display = 'flex';
}

function showEditForm(id) {
    document.getElementById("sme-name-" + id).style.display = "none";
    document.getElementById("sme-form-" + id).style.display = "flex";
}

function hideEditForm(id) {
    document.getElementById("sme-name-" + id).style.display = "inline";
    document.getElementById("sme-form-" + id).style.display = "none";
}
</script>

<script>
function toggleSMEEdit() {
    // Loop over all SMEs and toggle visibility
    const smeSpans = document.querySelectorAll("[id^='sme-name-']");
    const smeForms = document.querySelectorAll("[id^='sme-form-']");

    smeSpans.forEach(span => span.style.display = "none");
    smeForms.forEach(form => form.style.display = "flex");

    // If no SME exists, show add form
    const noSME = document.getElementById("no-sme-msg");
    const addSMEForm = document.getElementById("add-sme-form");
    if (noSME && addSMEForm) {
        noSME.style.display = "none";
        addSMEForm.style.display = "flex";
    }
}

function cancelSMEEdit(id) {
    document.getElementById("sme-name-" + id).style.display = "inline";
    document.getElementById("sme-form-" + id).style.display = "none";
}

function cancelNewSME() {
    document.getElementById("no-sme-msg").style.display = "block";
    document.getElementById("add-sme-form").style.display = "none";
}
</script>


{% endblock %}
